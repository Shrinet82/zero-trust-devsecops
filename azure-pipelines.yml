trigger:
  - main

variables:
  # MUST MATCH YOUR TERRAFORM OUTPUT
  azureContainerRegistry: "acrshrinet82prod.azurecr.io"
  imageRepository: "devsecops-sample-app"
  dockerfilePath: "app/Dockerfile"
  tag: "$(Build.BuildId)"
  # UPDATED TO MATCH YOUR ACTUAL CONNECTION NAME FROM SCREENSHOT
  azureServiceConnection: "Azure-DevSecOps-Connection"

stages:
  - stage: BuildAndSecurityScan
    displayName: "CI Stage: Build and Scan"
    jobs:
      - job: Build
        pool:
          name: "VMSS-Pool"
        steps:
          # SELF-HEAL: Install Azure CLI if missing (Fixes "az not installed" and "apt lock" errors)
          - script: |
              if ! command -v az &> /dev/null; then
                  echo "Azure CLI not found. Installing..."
                  # Wait for any background apt processes to finish
                  while fuser /var/lib/dpkg/lock-frontend >/dev/null 2>&1; do
                      echo "Waiting for apt lock..."
                      sleep 5
                  done
                  
                  # Force clean locks if stuck
                  sudo rm -f /var/lib/dpkg/lock-frontend /var/lib/dpkg/lock
                  
                  # Repair dpkg if interrupted
                  sudo dpkg --configure -a || true
                  
                  curl -sL https://aka.ms/InstallAzureCLIDeb | sudo bash
              else
                  echo "Azure CLI already installed."
              fi
              az --version
            displayName: "Ensure Azure CLI Installed"

          - task: AzureCLI@2
            displayName: "Build and Log into ACR"
            inputs:
              azureSubscription: $(azureServiceConnection)
              scriptType: "bash"
              scriptLocation: "inlineScript"
              inlineScript: |
                # 1. Login to ACR using the OIDC Identity
                az acr login --name $(azureContainerRegistry)

                # 2. Build the Docker Image
                docker build -t $(azureContainerRegistry)/$(imageRepository):$(tag) app/
                docker tag $(azureContainerRegistry)/$(imageRepository):$(tag) $(azureContainerRegistry)/$(imageRepository):latest

          # STRICT: Vulnerability Scan before pushing to Registry
          - script: |
              curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sh -s -- -b .
              ./trivy image --exit-code 1 --severity HIGH,CRITICAL $(azureContainerRegistry)/$(imageRepository):$(tag)
            displayName: "Trivy Security Scan (Kill Logic)"

          # Only push if the security scan passes
          - task: AzureCLI@2
            displayName: "Push to ACR"
            inputs:
              azureSubscription: $(azureServiceConnection)
              scriptType: "bash"
              scriptLocation: "inlineScript"
              inlineScript: |
                # 1. Login again (just to be safe/stateless)
                az acr login --name $(azureContainerRegistry)

                # 2. Push the images
                docker push $(azureContainerRegistry)/$(imageRepository):$(tag)
                docker push $(azureContainerRegistry)/$(imageRepository):latest

  - stage: DeployToAKS
    displayName: "CD Stage: Zero-Trust Deploy"
    # STRICT: Only run if CI stage succeeded
    dependsOn: BuildAndSecurityScan
    condition: succeeded()
    jobs:
      - deployment: Deploy
        displayName: "Deploy to AKS"
        environment: "Production"
        pool:
          name: "VMSS-Pool"
        strategy:
          runOnce:
            deploy:
              steps:
                - checkout: self
                - script: |
                    echo "Checking workspace contents:"
                    ls -R $(System.DefaultWorkingDirectory)

                    echo "Installing Kubelogin (Runtime)..."
                    sudo curl -L https://github.com/Azure/kubelogin/releases/download/v0.0.32/kubelogin-linux-amd64.zip -o kubelogin.zip
                    sudo apt-get install -y unzip
                    sudo unzip -o kubelogin.zip
                    sudo mv bin/linux_amd64/kubelogin /usr/bin/kubelogin
                    sudo chmod +x /usr/bin/kubelogin
                    kubelogin --version
                  displayName: "Debug & Install Kubelogin"
                - task: KubernetesManifest@1
                  displayName: "Apply Zero-Trust Manifests"
                  inputs:
                    action: "deploy"
                    connectionType: "azureResourceManager"
                    azureSubscriptionConnection: $(azureServiceConnection)
                    azureResourceGroup: "rg-devsecops-prod"
                    kubernetesCluster: "aks-devsecops-prod"
                    manifests: "k8s/deployment.yaml"
                    containers: "$(azureContainerRegistry)/$(imageRepository):$(tag)"
