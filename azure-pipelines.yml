trigger:
  - main

variables:
  # MUST MATCH YOUR TERRAFORM OUTPUT
  azureContainerRegistry: "acrshrinet82prod.azurecr.io"
  imageRepository: "devsecops-sample-app"
  dockerfilePath: "app/Dockerfile"
  tag: "$(Build.BuildId)"
  # UPDATED TO MATCH YOUR ACTUAL CONNECTION NAME FROM SCREENSHOT
  azureServiceConnection: "Azure-DevSecOps-Connection"

stages:
  - stage: BuildAndSecurityScan
    displayName: "CI Stage: Build and Scan"
    jobs:
      - job: Build
        pool:
          vmImage: "ubuntu-latest"
        steps:
          - task: Docker@2
            displayName: "Build Docker Image"
            inputs:
              command: "build"
              repository: $(imageRepository)
              dockerfile: $(dockerfilePath)
              containerRegistry: $(azureServiceConnection)
              tags: |
                $(tag)
                latest

          - script: |
              curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sh -s -- -b .
              ./trivy image --exit-code 1 --severity HIGH,CRITICAL $(azureContainerRegistry)/$(imageRepository):$(tag)
            displayName: "Trivy Security Scan (Kill Logic)"

          - task: Docker@2
            displayName: "Push to ACR"
            inputs:
              command: "push"
              repository: $(imageRepository)
              containerRegistry: $(azureServiceConnection)
              tags: |
                $(tag)
                latest

  - stage: DeployToAKS
    displayName: "CD Stage: Zero-Trust Deploy"
    # STRICT: Only run if CI stage succeeded
    dependsOn: BuildAndSecurityScan
    condition: succeeded()
    jobs:
      - deployment: Deploy
        displayName: "Deploy to AKS"
        environment: "Production"
        pool:
          vmImage: "ubuntu-latest"
        strategy:
          runOnce:
            deploy:
              steps:
                - task: KubernetesManifest@1
                  displayName: "Apply Zero-Trust Manifests"
                  inputs:
                    action: "deploy"
                    connectionType: "azureResourceManager"
                    azureSubscriptionConnection: $(azureServiceConnection)
                    azureResourceGroup: "rg-devsecops-prod"
                    kubernetesCluster: "aks-devsecops-prod"
                    manifests: "k8s/deployment.yaml"
                    containers: "$(azureContainerRegistry)/$(imageRepository):$(tag)"
