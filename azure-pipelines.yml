trigger:
  - main

variables:
  # MUST MATCH YOUR TERRAFORM OUTPUT
  azureContainerRegistry: "acrshrinet82prod.azurecr.io"
  imageRepository: "devsecops-sample-app"
  dockerfilePath: "app/Dockerfile"
  tag: "$(Build.BuildId)"
  # UPDATED TO MATCH YOUR ACTUAL CONNECTION NAME FROM SCREENSHOT
  azureServiceConnection: "Azure-DevSecOps-Connection"

stages:
  # -------------------------------------------------------------------------
  # STAGE 1: SECURITY GATES (Fail Fast)
  # -------------------------------------------------------------------------
  - stage: SecurityGates
    displayName: "Stage 1: Security Gates (Pre-Commit)"
    jobs:
      - job: SecretScan
        displayName: "Secret Scan (Gitleaks)"
        pool:
          name: "VMSS-Pool"
        steps:
          - script: |
              curl -sS https://webi.sh/gitleaks | sh
              ~/.local/bin/gitleaks detect --source . -v
            displayName: "Run Gitleaks"

      - job: IaCScan
        displayName: "IaC Scan (Checkov)"
        pool:
          name: "VMSS-Pool"
        steps:
          - script: |
              # Wait for apt lock
              while fuser /var/lib/dpkg/lock-frontend >/dev/null 2>&1; do sleep 5; done
              sudo dpkg --configure -a || true

              sudo apt-get update
              sudo apt-get install -y python3-pip
              pip3 install checkov
              checkov -d k8s/ --check CKV_K8S_21,CKV_K8S_40,CKV_K8S_10,CKV_K8S_11,CKV_K8S_12,CKV_K8S_13,CKV_K8S_28 --soft-fail
            displayName: "Run Checkov (K8s)"

  # -------------------------------------------------------------------------
  # STAGE 2: APP QUALITY (Lint & Test)
  # -------------------------------------------------------------------------
  - stage: AppQuality
    displayName: "Stage 2: App Quality"
    dependsOn: SecurityGates
    jobs:
      - job: Linting
        displayName: "Linting (Flake8)"
        pool:
          name: "VMSS-Pool"
        steps:
          - script: |
              # Wait for apt lock
              while fuser /var/lib/dpkg/lock-frontend >/dev/null 2>&1; do sleep 5; done
              sudo dpkg --configure -a || true

              sudo apt-get install -y python3-pip
              pip3 install flake8
              flake8 app/ --count --select=E9,F63,F7,F82 --show-source --statistics
              flake8 app/ --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics
            displayName: "Run Flake8"

      - job: SAST
        displayName: "SAST (Trivy FS)"
        pool:
          name: "VMSS-Pool"
        steps:
          - script: |
              curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sh -s -- -b .
              ./trivy fs --exit-code 1 --severity CRITICAL,HIGH .
            displayName: "Trivy Repo Scan"

      - job: UnitTests
        displayName: "Unit Tests (Pytest)"
        pool:
          name: "VMSS-Pool"
        steps:
          - script: |
              # Wait for apt lock
              while fuser /var/lib/dpkg/lock-frontend >/dev/null 2>&1; do sleep 5; done
              sudo dpkg --configure -a || true

              sudo apt-get install -y python3-pip
              pip3 install pytest flask
              pytest --junitxml=test-results.xml
            displayName: "Run Pytest"

          - task: PublishTestResults@2
            condition: succeededOrFailed()
            inputs:
              testResultsFormat: "JUnit"
              testResultsFiles: "**/test-results.xml"
            displayName: "Publish Test Results"

  # -------------------------------------------------------------------------
  # STAGE 3: THE FACTORY (Build & Artifacts)
  # -------------------------------------------------------------------------
  - stage: BuildFactory
    displayName: "Stage 3: The Factory (Build)"
    dependsOn: AppQuality
    jobs:
      - job: Build
        pool:
          name: "VMSS-Pool"
        steps:
          - script: |
              if ! command -v az &> /dev/null; then
                  echo "Azure CLI not found. Installing..."
                  sudo curl -sL https://aka.ms/InstallAzureCLIDeb | sudo bash
              fi
            displayName: "Ensure Azure CLI"

          - task: AzureCLI@2
            displayName: "Build and Log into ACR"
            inputs:
              azureSubscription: $(azureServiceConnection)
              scriptType: "bash"
              inlineScript: |
                az acr login --name $(azureContainerRegistry)
                docker build -t $(azureContainerRegistry)/$(imageRepository):$(tag) app/
                docker tag $(azureContainerRegistry)/$(imageRepository):$(tag) $(azureContainerRegistry)/$(imageRepository):latest

          # SBOM GENERATION (CycloneDX)
          - script: |
              ./trivy image --format cyclonedx --output sbom.json $(azureContainerRegistry)/$(imageRepository):$(tag)
            displayName: "Generate SBOM (CycloneDX)"

          - task: PublishBuildArtifacts@1
            inputs:
              PathtoPublish: "sbom.json"
              ArtifactName: "SBOM"
            displayName: "Publish SBOM Artifact"

          # KILL LOGIC (Trivy Image Scan)
          - script: |
              ./trivy image --exit-code 1 --severity CRITICAL $(azureContainerRegistry)/$(imageRepository):$(tag)
            displayName: "Trivy Image Scan (Block Critical)"

          - task: AzureCLI@2
            displayName: "Push to ACR"
            inputs:
              azureSubscription: $(azureServiceConnection)
              scriptType: "bash"
              inlineScript: |
                az acr login --name $(azureContainerRegistry)
                docker push $(azureContainerRegistry)/$(imageRepository):$(tag)
                docker push $(azureContainerRegistry)/$(imageRepository):latest

  # -------------------------------------------------------------------------
  # STAGE 4: DELIVERY (Deployment)
  # -------------------------------------------------------------------------
  - stage: Delivery
    displayName: "Stage 4: Delivery (Deploy)"
    dependsOn: BuildFactory
    jobs:
      - deployment: Deploy
        displayName: "Deploy to AKS"
        environment: "Production"
        pool:
          name: "VMSS-Pool"
        strategy:
          runOnce:
            deploy:
              steps:
                - checkout: self
                - script: |
                    sudo curl -L https://github.com/Azure/kubelogin/releases/download/v0.0.32/kubelogin-linux-amd64.zip -o kubelogin.zip
                    sudo unzip -o kubelogin.zip && sudo mv bin/linux_amd64/kubelogin /usr/bin/kubelogin && sudo chmod +x /usr/bin/kubelogin
                  displayName: "Install Kubelogin"

                - task: KubernetesManifest@1
                  displayName: "Apply Manifests"
                  inputs:
                    action: "deploy"
                    connectionType: "azureResourceManager"
                    azureSubscriptionConnection: $(azureServiceConnection)
                    azureResourceGroup: "rg-devsecops-prod"
                    kubernetesCluster: "aks-devsecops-prod"
                    manifests: |
                      k8s/secretproviderclass.yaml
                      k8s/deployment.yaml
                    containers: "$(azureContainerRegistry)/$(imageRepository):$(tag)"

  # -------------------------------------------------------------------------
  # STAGE 5: LIVE VERIFICATION (Prove It)
  # -------------------------------------------------------------------------
  - stage: LiveVerification
    displayName: "Stage 5: Live Verification"
    dependsOn: Delivery
    jobs:
      - job: Verify
        displayName: "Smoke Test & DAST"
        pool:
          name: "VMSS-Pool"
        steps:
          - task: AzureCLI@2
            displayName: "Setup Access"
            inputs:
              azureSubscription: $(azureServiceConnection)
              scriptType: "bash"
              inlineScript: |
                az aks get-credentials -g rg-devsecops-prod -n aks-devsecops-prod
                kubelogin convert-kubeconfig -l azurecli

          - script: |
              echo "Waiting for pod rollout..."
              kubectl rollout status deployment/sample-app --timeout=60s
              kubectl get pods -l app=sample-app
            displayName: "Smoke Test (Rollout Status)"

          - script: |
              echo "Starting Port Forward for DAST..."
              # Run port-forward in background
              kubectl port-forward svc/sample-app 8080:80 &
              PID=$!

              echo "Waiting for port-forward..."
              sleep 10

              echo "Running OWASP ZAP Baseline Scan..."
              # Pull ZAP image
              docker pull ghcr.io/zaproxy/zaproxy:stable

              # Run ZAP against localhost (using host network or special docker networking)
              docker run -v $(pwd):/zap/wrk/:rw --network host -t ghcr.io/zaproxy/zaproxy:stable zap-baseline.py \
                -t http://localhost:8080 \
                -r zap_report.html \
                -I  # Fail only on errors

              # Cleanup
              kill $PID
            displayName: "DAST (OWASP ZAP Scan)"

          - task: PublishBuildArtifacts@1
            inputs:
              PathtoPublish: "zap_report.html"
              ArtifactName: "ZAP_Report"
            displayName: "Publish DAST Report"
